<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TV File Browser</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      padding: 20px;
    }
    a {
      display: block;
      padding: 8px;
      margin: 4px 0;
      color: #0af;
      text-decoration: none;
      position: relative;
    }
    a:hover {
      background: #222;
    }
    .progress-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: #0af;
      transition: width 0.3s ease;
    }
    .continue-watching {
      margin-bottom: 30px;
    }
    .continue-watching h3 {
      color: #0af;
      margin-bottom: 10px;
    }
    .continue-item {
      display: flex;
      align-items: center;
      padding: 12px 8px;
      margin: 4px 0;
      background: #111;
      border-radius: 4px;
      cursor: pointer;
    }
    .continue-item:hover {
      background: #222;
    }
    .continue-info {
      flex: 1;
    }
    .continue-progress {
      font-size: 12px;
      color: #888;
      margin-top: 4px;
    }
    .continue-time {
      font-size: 12px;
      color: #0af;
      margin-left: 10px;
    }
    #player {
      margin-top: 20px;
    }
    video {
      width: 100%;
      max-height: 80vh;
      background: #000;
    }
    .section {
      margin-bottom: 30px;
    }
    .debug {
      background: #333;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h2>TV File Browser</h2>
  
  <!-- Debug info -->
  <div class="debug">
    <strong>Debug Info:</strong><br>
    Current URL: <span id="current-url"></span><br>
    Base URL: <span id="base-url"></span><br>
    Status: <span id="status">Loading...</span>
  </div>
  
  <div id="continue-watching" class="section continue-watching" style="display: none;">
    <h3>Continue Watching</h3>
    <div id="continue-list"></div>
  </div>

  <div class="section">
    <h3>All Files</h3>
    <div id="file-list">Loading...</div>
  </div>
  
  <div id="player"></div>

  <script>
    // Use dynamic base URL
    const baseUrl = new URL('./', window.location.href).href;
    
    // Debug info
    document.getElementById('current-url').textContent = window.location.href;
    document.getElementById('base-url').textContent = baseUrl;

    // Storage for viewing progress
    function getWatchProgress() {
      const stored = localStorage.getItem('watchProgress');
      return stored ? JSON.parse(stored) : {};
    }

    function saveWatchProgress(filename, currentTime, duration) {
      const progress = getWatchProgress();
      const progressPercent = (currentTime / duration) * 100;
      
      // Only save if watched more than 5% and less than 95%
      if (progressPercent > 5 && progressPercent < 95) {
        progress[filename] = {
          currentTime: currentTime,
          duration: duration,
          timestamp: Date.now(),
          progressPercent: progressPercent
        };
      } else if (progressPercent >= 95) {
        // Remove from continue watching if finished
        delete progress[filename];
      }
      
      localStorage.setItem('watchProgress', JSON.stringify(progress));
      updateContinueWatching();
    }

    function updateContinueWatching() {
      const progress = getWatchProgress();
      const continueSection = document.getElementById('continue-watching');
      const continueList = document.getElementById('continue-list');
      
      const items = Object.entries(progress)
        .sort((a, b) => b[1].timestamp - a[1].timestamp) // Sort by most recent
        .slice(0, 10); // Show only 10 most recent
      
      if (items.length === 0) {
        continueSection.style.display = 'none';
        return;
      }
      
      continueSection.style.display = 'block';
      continueList.innerHTML = '';
      
      items.forEach(([filename, data]) => {
        const item = document.createElement('div');
        item.className = 'continue-item';
        
        const progressBar = Math.round(data.progressPercent);
        const currentTimeFormatted = formatTime(data.currentTime);
        const durationFormatted = formatTime(data.duration);
        
        item.innerHTML = `
          <div class="continue-info">
            <div>${filename}</div>
            <div class="continue-progress">${progressBar}% watched</div>
          </div>
          <div class="continue-time">${currentTimeFormatted} / ${durationFormatted}</div>
        `;
        
        item.onclick = () => {
          playVideo(filename, data.currentTime);
        };
        
        continueList.appendChild(item);
      });
    }

    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hrs > 0) {
        return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    async function loadFiles() {
      const statusEl = document.getElementById('status');
      try {
        statusEl.textContent = 'Fetching directory listing...';
        console.log('Fetching from:', baseUrl);
        
        const res = await fetch(baseUrl);
        
        statusEl.textContent = `Response status: ${res.status}`;
        console.log('Response status:', res.status);
        console.log('Response headers:', res.headers);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const text = await res.text();
        console.log('Response text length:', text.length);
        console.log('First 500 chars:', text.substring(0, 500));

        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/html");
        const links = Array.from(doc.querySelectorAll("a"));
        
        console.log('Found links:', links.length);
        statusEl.textContent = `Found ${links.length} links`;

        const list = document.getElementById("file-list");
        list.innerHTML = "";

        const progress = getWatchProgress();
        let fileCount = 0;

        links.forEach((link, index) => {
          const href = link.getAttribute("href");
          console.log(`Link ${index}:`, href, 'Text:', link.textContent);
          
          if (!href || href.startsWith("?") || href === "../") {
            console.log(`Skipping link: ${href}`);
            return;
          }

          // Check if it's a video file
          const videoExtensions = ['.mp4', '.mkv', '.avi', '.mov', '.wmv', '.flv', '.webm'];
          const isVideo = videoExtensions.some(ext => href.toLowerCase().endsWith(ext));
          
          const item = document.createElement("a");
          item.textContent = href + (isVideo ? ' (video)' : '');
          item.href = "#";
          item.style.position = 'relative';
          
          // Add progress bar if file has been watched
          if (progress[href]) {
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressBar.style.width = progress[href].progressPercent + '%';
            item.appendChild(progressBar);
          }
          
          item.onclick = () => {
            playVideo(href);
            return false;
          };
          list.appendChild(item);
          fileCount++;
        });
        
        statusEl.textContent = `Loaded ${fileCount} files successfully`;
        updateContinueWatching();
        
      } catch (err) {
        console.error('Error loading files:', err);
        statusEl.textContent = `Error: ${err.message}`;
        document.getElementById("file-list").innerHTML = `
          <div style="color: #f44;">
            Failed to load files: ${err.message}<br>
            <small>Check console for more details</small>
          </div>
        `;
      }
    }

    function srtToVtt(data) {
      return "WEBVTT\n\n" + data
        .replace(/\r+/g, "")
        .replace(/^\d+\s*$/gm, "")
        .replace(/,/g, ".");
    }

    async function playVideo(filename, startTime = 0) {
      const player = document.getElementById("player");
      const videoUrl = baseUrl + filename;
      const srtUrl = baseUrl + filename.replace(/\.[^.]+$/, ".srt");

      console.log('Playing video:', videoUrl);

      player.innerHTML = `
        <video controls autoplay>
          <source src="${videoUrl}" type="video/mp4">
        </video>
      `;

      const video = player.querySelector("video");
      
      // Set start time if resuming
      if (startTime > 0) {
        video.currentTime = startTime;
      }

      // Track progress every 30 seconds
      let progressInterval;
      
      video.onloadedmetadata = () => {
        progressInterval = setInterval(() => {
          if (!video.paused && video.duration > 0) {
            saveWatchProgress(filename, video.currentTime, video.duration);
          }
        }, 30000); // Save every 30 seconds
      };

      // Save progress when video ends or is paused for a while
      video.onpause = () => {
        if (video.duration > 0) {
          saveWatchProgress(filename, video.currentTime, video.duration);
        }
      };

      video.onended = () => {
        if (progressInterval) {
          clearInterval(progressInterval);
        }
        // Remove from continue watching when finished
        const progress = getWatchProgress();
        delete progress[filename];
        localStorage.setItem('watchProgress', JSON.stringify(progress));
        updateContinueWatching();
        loadFiles(); // Refresh to update progress bars
      };

      // Save progress when user seeks
      video.onseeked = () => {
        if (video.duration > 0) {
          saveWatchProgress(filename, video.currentTime, video.duration);
        }
      };

      // Load subtitles
      try {
        const res = await fetch(srtUrl);
        if (res.ok) {
          const srtText = await res.text();
          const vttBlob = new Blob([srtToVtt(srtText)], { type: "text/vtt" });
          const vttUrl = URL.createObjectURL(vttBlob);

          const track = document.createElement("track");
          track.kind = "subtitles";
          track.label = "Subtitles";
          track.srclang = "en";
          track.src = vttUrl;
          track.default = true;
          video.appendChild(track);
        }
      } catch (err) {
        console.warn("No subtitles found for " + filename);
      }
    }

    // Initialize
    loadFiles();
  </script>
</body>
</html>